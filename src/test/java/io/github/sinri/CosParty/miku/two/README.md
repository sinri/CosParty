# CosParty 多角色讨论系统示例

## 示例目标

本示例展示如何使用 CosParty 框架构建一个**多角色智能讨论系统**，实现以下功能：

- 模拟真实的技术讨论场景
- 多个角色基于不同背景和观点进行发言
- 智能主持人引导讨论进程并做出决策
- 自动化的讨论流程控制和总结

## 核心机制

### 1. 场景驱动的工作流

系统采用**场景（Scene）**作为基本执行单元，每个场景负责特定的业务逻辑：

- **StartScene**: 初始化讨论环境，注册参与者和主持人
- **OneRoundScene**: 让所有参与者轮流发言
- **AfterOneRoundScene**: 主持人分析讨论进展，决定是否继续
- **EndScene**: 总结讨论并形成结论

### 2. 上下文管理机制

使用 `CosplayContext` 管理全局状态，关键字段包括：
- `topic`: 讨论主题
- `members`: 参与者列表
- `conversation_context_id`: 对话上下文ID
- `round_count`: 讨论轮次计数
- `end_flag`: 结束标志

### 3. 对话上下文系统

通过 `ConversationContext` 管理参与者注册和对话历史：
- 每个参与者都有独特的身份和指令
- 自动维护完整的发言记录
- 支持动态角色注册

### 4. 智能决策机制

主持人通过 AI 分析讨论内容，基于关键词判断是否继续：
- 检测"继续讨论"或"结束讨论"关键词
- 最多支持4轮讨论，避免无限循环
- 使用不同AI模型处理不同任务

## 框架运用要点

### 1. 脚本定义

继承 `MikuScript` 并实现 `seekNextSceneInScript` 方法，定义场景流转逻辑。关键是要正确处理条件分支，避免死循环。

### 2. 场景实现

每个场景继承 `MikuScene` 并实现 `playInner` 方法。注意异步操作的正确处理，使用 `Future` 链式调用。

### 3. 角色管理

使用 `DynamicActor` 创建角色，通过 `actorInstruction` 定义角色特点。角色描述要具体明确，影响AI生成质量。

### 4. AI服务集成

使用 `MixChatKit` 调用AI服务，注意：
- 选择合适的模型（QwenPlus/QwenTurbo/QwenMax）
- 正确设置角色身份和上下文
- 处理AI响应和错误

## 关键实现细节

### 1. 异步迭代处理

在 `OneRoundScene` 中使用 `Keel.asyncCallIteratively` 让参与者轮流发言，避免并发冲突。

### 2. 状态持久化

通过 `CosplayContext` 的 `writeNumber` 和 `readInteger` 方法管理轮次计数，确保状态正确传递。

### 3. 条件判断逻辑

在 `AfterOneRoundScene` 中通过字符串匹配判断AI决策，简单有效但需要注意关键词的准确性。

### 4. 对话历史管理

使用 `Conversation` 对象自动维护发言记录，每个场景都能获取完整历史。

## 常见陷阱和解决方案

### 1. 异步操作处理

**陷阱**: 在异步操作中直接返回结果，导致状态丢失
**解决**: 使用 `Future.compose` 链式调用，确保状态正确传递

### 2. 角色注册顺序

**陷阱**: 角色注册顺序影响发言顺序
**解决**: 在 `OneRoundScene` 中明确跳过主持人，按注册顺序处理其他角色

### 3. AI响应解析

**陷阱**: AI可能返回格式不标准的响应
**解决**: 使用简单的关键词匹配，避免复杂的自然语言解析

### 4. 轮次控制

**陷阱**: 无限循环讨论
**解决**: 设置最大轮次限制，并在主持人判断中设置结束条件

### 5. 上下文传递

**陷阱**: 场景间状态丢失
**解决**: 使用 `CosplayContext` 统一管理状态，避免局部变量传递

## 扩展建议

### 1. 自定义讨论主题

修改 `Discussion.java` 中的主题参数，确保主题有争议性和讨论价值。

### 2. 角色设计

- 角色背景要具体明确
- 观点要有冲突性
- 避免角色过于相似

### 3. 讨论控制

- 调整最大轮次限制
- 优化主持人判断逻辑
- 添加超时机制

### 4. 性能优化

- 选择合适的AI模型
- 控制并发调用数量
- 监控API调用成本

## 技术特点总结

1. **模块化设计**: 场景分离，职责明确
2. **状态管理**: 统一的上下文管理机制
3. **异步处理**: 基于Vert.x的异步架构
4. **智能决策**: AI驱动的流程控制
5. **可扩展性**: 易于添加新场景和角色

这个示例展示了 CosParty 框架在构建复杂对话系统方面的强大能力，为其他多角色交互场景提供了良好的参考模板。
