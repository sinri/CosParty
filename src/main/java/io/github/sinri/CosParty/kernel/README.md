# CosParty Kernel 核心引擎

## 概述

CosParty Kernel 是一个角色扮演系统的核心引擎，提供了完整的场景管理、状态控制和对话处理框架。该引擎采用基于场景的执行模型，支持复杂的业务逻辑编排和状态流转。

## 设计理念

### 1. 场景驱动架构

Kernel 采用场景（Scene）作为基本执行单元，每个场景代表一个独立的业务逻辑片段。场景可以组合成复杂的执行流程，形成完整的角色扮演体验。

### 2. 分层上下文管理

系统采用分层上下文设计：

- **脚本级别上下文**：管理整个脚本执行过程中的全局状态
- **动作级别上下文**：管理特定动作执行期间的局部状态
- **对话上下文**：管理多角色对话的状态和历史

### 3. 状态隔离与传递

通过明确的输入输出机制，确保不同作用域间的状态隔离，同时支持必要的数据传递。

## 核心组件

### 1. CosplayEngine（角色扮演引擎）

**职责**：协调整个角色扮演系统的执行流程

**核心功能**：

- 管理场景的执行顺序和跳转
- 维护动作栈，支持嵌套场景结构
- 处理上下文的作用域切换
- 提供统一的日志和错误处理

**执行流程**：

1. 初始化引擎和脚本级别上下文
2. 获取起始场景并开始执行循环
3. 根据场景执行结果确定下一个场景
4. 处理动作的输入输出和上下文切换
5. 当脚本执行完毕时结束

### 2. CosplayScript（角色扮演脚本）

**职责**：定义场景的执行流程和跳转逻辑

**核心功能**：

- 提供起始场景
- 管理场景的注册和查找
- 根据当前状态决定下一个执行场景

### 3. CosplayScene（角色扮演场景）

**职责**：实现具体的业务逻辑

**生命周期**：

- **初始化**：设置场景的初始状态
- **执行**：实现具体的业务逻辑
- **结束**：清理资源并返回执行结果

### 4. CosplayAction（角色扮演动作）

**职责**：实现复杂的嵌套场景逻辑

**特殊功能**：

- 维护独立的动作级别上下文
- 管理子场景的执行流程
- 处理与外部作用域的数据交换

### 5. CosplayContext（角色扮演上下文）

**职责**：管理状态数据和对话历史

**核心特性**：

- 支持多种数据类型的存储（字符串、数值、JSON等）
- 提供对话上下文管理
- 支持数据的作用域隔离和传递

## 运作方式

### 1. 引擎启动流程

```
引擎构造 → 初始化 → 设置输入参数 → 获取起始场景 → 开始执行循环
```

### 2. 场景执行循环

```
当前场景执行 → 确定下一个场景 → 场景跳转 → 重复执行
```

### 3. 动作嵌套处理

当遇到 `CosplayAction` 时：

1. 将动作推入动作栈
2. 创建动作级别的上下文
3. 执行动作的输入操作
4. 在动作作用域内执行子场景
5. 动作结束时执行输出操作并弹出栈

### 4. 上下文管理

- **脚本级别**：整个脚本执行期间有效
- **动作级别**：仅在特定动作执行期间有效
- **对话级别**：管理多角色对话的状态和历史

## 设计优势

### 1. 模块化设计

每个组件职责明确，便于维护和扩展。场景可以独立开发和测试，然后组合成复杂的业务流程。

### 2. 状态管理清晰

通过分层上下文设计，确保状态的作用域清晰，避免数据污染，同时支持必要的数据共享。

### 3. 灵活的流程控制

支持复杂的场景跳转逻辑，可以实现条件分支、循环、嵌套等复杂的业务流程。

### 4. 可扩展性强

新的场景类型可以通过实现相应接口来扩展，引擎本身不需要修改。

## 使用场景

### 1. 角色扮演游戏

- 多角色对话场景
- 剧情分支选择
- 角色状态管理

### 2. 交互式故事

- 动态剧情生成
- 用户选择影响故事走向
- 多线程故事线管理

### 3. 对话系统

- 复杂的对话流程
- 上下文感知的回复
- 多轮对话状态管理

## 核心概念总结

1. **场景（Scene）**：系统的基本执行单元，包含具体的业务逻辑
2. **脚本（Script）**：场景的集合，定义执行流程和跳转逻辑
3. **引擎（Engine）**：协调整个系统的执行，管理场景流转
4. **上下文（Context）**：管理状态数据，支持分层作用域
5. **动作（Action）**：复杂的场景类型，支持嵌套执行

这个设计使得 CosParty 能够处理复杂的角色扮演场景，同时保持代码的清晰性和可维护性。通过场景驱动的架构，开发者可以轻松构建各种复杂的交互式体验。
